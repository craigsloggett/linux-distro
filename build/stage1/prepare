#!/bin/sh -e
#
# Stage 1 - prepare build environment.

BUILD_USER=build
BUILD_GROUP=build
BUILD_ROOT=/mnt/build

# Create a build user (non-root).
getent group "${BUILD_GROUP}" > /dev/null || groupadd "${BUILD_GROUP}"
id -u "${BUILD_USER}" > /dev/null || useradd -s /bin/bash -g "${BUILD_GROUP}" -m -k /dev/null "${BUILD_USER}"

cat > /home/"${BUILD_USER}"/.bash_profile << "EOF"
exec env -i HOME=$HOME TERM=$TERM PS1='\u:\w\n\$ ' /bin/bash
EOF

cat > /home/"${BUILD_USER}"/.bashrc << "EOF"
set +h
umask 022
LC_ALL=POSIX
PATH=/tools/bin:/bin:/usr/bin

STAGE1_DEST=/mnt/build
STAGE1_TARGET="x86_64-stage1-linux-musl"
STAGE1_ARCH="x86"
STAGE1_CPU="x86-64"
STAGE1_HOST="x86_64-pc-linux-gnu"

export STAGE1_DEST STAGE1_TARGET STAGE1_ARCH STAGE1_CPU STAGE1_HOST LC_ALL PATH

unset CFLAGS
unset CXXFLAGS
EOF

chmod 0644 /home/"${BUILD_USER}"/.bashrc
chmod 0644 /home/"${BUILD_USER}"/.bash_profile

chown "${BUILD_USER}":"${BUILD_GROUP}" /home/"${BUILD_USER}"/.bashrc
chown "${BUILD_USER}":"${BUILD_GROUP}" /home/"${BUILD_USER}"/.bash_profile

# Prepare the Build Directories and Permissions
install -dm 755 -o "${BUILD_USER}" -g "${BUILD_GROUP}" "${BUILD_ROOT}"
install -dm 777 -o "${BUILD_USER}" -g "${BUILD_GROUP}" "${BUILD_ROOT}"/source
install -dm 755 -o "${BUILD_USER}" -g "${BUILD_GROUP}" "${BUILD_ROOT}"/tools
install -dm 755 -o "${BUILD_USER}" -g "${BUILD_GROUP}" "${BUILD_ROOT}"/tools/lib

# Link the directory containing the compiled tools to the build system.
ln -sv $BROOT/tools /

su - build

