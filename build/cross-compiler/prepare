#!/bin/sh -e
#
# Cross Compiler - prepare build environment.

BUILD_USER=build
BUILD_GROUP=build
BUILD_ROOT_DIR=/home/"${BUILD_USER}"/cross-compiler

# Create a build user (non-root).
getent group "${BUILD_GROUP}" > /dev/null || groupadd "${BUILD_GROUP}"
id -u "${BUILD_USER}" > /dev/null || useradd -s /bin/bash -g "${BUILD_GROUP}" -m -k /dev/null "${BUILD_USER}"

# Setup their environment.
cat > /home/"${BUILD_USER}"/.bash_profile << "EOF"
exec env -i HOME=$HOME TERM=$TERM PS1='\u:\w\n\$ ' /bin/bash
EOF

cat > /home/"${BUILD_USER}"/.bashrc << "EOF"
set +h
umask 022

LC_ALL=POSIX
PATH=/tools/bin:/bin:/usr/bin

export LC_ALL
export PATH

STAGE1_TARGET="x86_64-linux-musl"
STAGE1_ARCH="x86"
STAGE1_CPU="x86-64"
STAGE1_HOST="x86_64-pc-linux-gnu"

export STAGE1_TARGET 
export STAGE1_ARCH 
export STAGE1_CPU 
export STAGE1_HOST 

unset CFLAGS
unset CXXFLAGS

EOF

chmod 0644 /home/"${BUILD_USER}"/.bashrc
chmod 0644 /home/"${BUILD_USER}"/.bash_profile

chown "${BUILD_USER}":"${BUILD_GROUP}" /home/"${BUILD_USER}"/.bashrc
chown "${BUILD_USER}":"${BUILD_GROUP}" /home/"${BUILD_USER}"/.bash_profile

# Prepare the build directories and permissions.
mkdir -p "${BUILD_ROOT_DIR}"
mkdir -p "${BUILD_ROOT_DIR}"/source
mkdir -p "${BUILD_ROOT_DIR}"/cross-tools

chmod 777 "${BUILD_ROOT_DIR}"/source

chown -R "${BUILD_USER}":"${BUILD_GROUP}" "${BUILD_ROOT_DIR}"

# Link the directory containing the compiled tools to the build system. 
# 
# This enables the toolchain to be compiled such that it always refers to 
# /cross-tools. This way, the compiler, assembler and linker will work in the 
# build environment and the chrooted environment just the same.
ln -sv "${BUILD_ROOT_DIR}"/cross-tools /

# Add the build directory to their environment.
printf 'STAGE1_ROOT_DIR=%s \n\nexport STAGE1_ROOT_DIR\n' "${BUILD_ROOT_DIR}" >> /home/"${BUILD_USER}"/.bashrc

